#!/bin/sh

# https://stackoverflow.com/questions/18691867/where-to-find-logs-for-a-cloud-init-user-data-script

# Logs for this script are stored in /var/log/cloud-init-output.log

# Ran out of memory very quickly, so using a swap file to help out a bit.
# https://linuxize.com/post/create-a-linux-swap-file/

echo "Configuring Swap File"
sudo fallocate -l 5G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Execute Simple Install Script for TPOT

echo

# # TPOT Cannot Uninstall Under an Admin Identity, hence we create a new user
# # Create the user with no password and a home directory
# sudo useradd -m -s /bin/bash "azureuser"
# # Remove the password (if any was set by default)
sudo passwd -d "adminuser"
# # Add the user to the sudoers file
# echo "azureuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers


# runcmd: env myQST="y" myTPOT_TYPE="h" myWEB_USER="SENIORDESIGN" myOK="Y" myWEB_PW=$PASSWORD myWEB_PW2=$PASSWORD bash -c "$(curl -sL https://github.com/uc-mestemax/honey-badger-tpotce/raw/refs/heads/customized-honeybadger-foundation/install.sh)"
echo

echo "Beginning TPOT Installation"


# env myQST="y" myTPOT_TYPE="h" myWEB_USER="SENIORDESIGN" myOK="Y" myWEB_PW=$PASSWORD myWEB_PW2=$PASSWORD bash -c "$(curl -sL https://github.com/uc-mestemax/honey-badger-tpotce/raw/master/install.sh)"
su - adminuser -c 'env myQST="y" myTPOT_TYPE="h" myWEB_USER="SENIORDESIGN" myOK="Y" myWEB_PW=$PASSWORD myWEB_PW2=$PASSWORD bash -c "$(curl -sL https://github.com/uc-mestemax/honey-badger-tpotce/raw/refs/heads/customized-honeybadger-foundation/install.sh)"'

sudo reboot